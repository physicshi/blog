---
sidebar_position: 9
---

## localStorage 满了怎么办

存不进去并报错（QuotaExceededError）

### 解决办法

首先要明确 localStorage 是绑定域名的，同一个域名（document.domain）共享同一个 localStorage

不同站点下的 Web 应用有着自己独立的存储对象，互相间是无法访问的，在这一点上 SessionStorage 和 LocalStorage 是相同的。

举个例子：部署在 abc.com 上的 Web 应用无法访问 xyz.com 的 Web Storage 存储对象。

同样，对于子域名也是一样，尽管 a.grapecity.com.cn 和 b.grapecity.com.cn 同属 grapecity.com.cn 主域下，但它们相互不能访问对方的存储对象。

:::tip
当然也可以降级到 sessionStorage 或者直接使用 IndexedDB，不过这里想说的是 iframe+postMessage

关于 IndexedDB 可以参考 [浏览器数据库 IndexedDB 入门教程](https://www.ruanyifeng.com/blog/2018/07/indexeddb.html)
:::

**把 8001 的 data 存到 8002 的 storage 中，并且在 8001 端口中读取 8002 端口中的 localStorage。**

核心就是 iframe+postMessage 实现页面与 iframe 之间的通信继而实现不同域名之间共享 localStorage

文件目录如下：

![image](https://tvax3.sinaimg.cn/large/006T9etDly1h0j1vv1htaj30cs0b642b.jpg)

server1.js

```js
const express = require("express");
const port = 8001;

const app = express();

app.use(express.static("./demo1"));

app.listen(port, () => {
  console.log("路由服务器启动成功，端口号为" + port);
});
```

server2.js

```js
const express = require("express");
const port = 8002;

const app = express();

app.use(express.static("./demo2"));

app.listen(port, () => {
  console.log("路由服务器启动成功，端口号为" + port);
});
```

demo1/index.html

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <iframe
      id="demo2-iframe"
      src="http://localhost:8002/index.html"
      style="display: none"
    ></iframe>
    <script>
      const obj = { age: 18 };
      console.log(localStorage.getItem("name"), "直接拿iframe的storage");
      window.onload = function () {
        const demoIframe = document.getElementById("demo2-iframe");
        // 要存的 data 传给 iframe
        demoIframe.contentWindow.postMessage(obj, "http://localhost:8002");
      };
      window.addEventListener(
        "message",
        function (event) {
          if (event.origin === "http://localhost:8002") {
            console.log(event.data, "拿iframe的storage");
          }
        },
        false
      );
    </script>
    <p>demo1 page</p>
  </body>
</html>
```

demo2/index.html

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      // ifrmae 存的 data
      localStorage.setItem("name", "111");
      // 监听 message 事件
      window.addEventListener(
        "message",
        function (event) {
          if (event.origin === "http://localhost:8001") {
            // console.log("message from 8001", event.data);
            localStorage.setItem("demo2", JSON.stringify(event.data));
            // iframe 的 storage 传给父级
            event.source.postMessage(
              {
                name: localStorage.getItem("name"),
                demo2: localStorage.getItem("demo2"),
              },
              event.origin
            );
          }
        },
        false
      );
    </script>
    <p>demo2 page</p>
  </body>
</html>
```

![image](https://tva4.sinaimg.cn/large/006T9etDly1h0j2mocnrrj316y0bwgtj.jpg)

![image](https://tvax3.sinaimg.cn/large/006T9etDly1h0j2k99rdoj30zk0ayace.jpg)

![image](https://tvax4.sinaimg.cn/large/006T9etDly1h0j2kqa188j30yw0co0v6.jpg)

- [深入浅出 iframe](https://www.jianshu.com/p/7ec986aa28a7)
