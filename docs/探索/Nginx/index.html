<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="我的秘密基地 Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="我的秘密基地 Blog Atom Feed"><title data-react-helmet="true">Nginx | 我的秘密基地</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://physicshi.github.io/docs/探索/Nginx"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Nginx | 我的秘密基地"><meta data-react-helmet="true" name="description" content="`shell"><meta data-react-helmet="true" property="og:description" content="`shell"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://physicshi.github.io/docs/探索/Nginx"><link data-react-helmet="true" rel="alternate" href="https://physicshi.github.io/docs/探索/Nginx" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://physicshi.github.io/docs/探索/Nginx" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.28eae8ec.css">
<link rel="preload" href="/assets/js/runtime~main.6ef7fc14.js" as="script">
<link rel="preload" href="/assets/js/main.c78f278f.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_RZKW">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_RFGx themedImage--light_Ble8 navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_RFGx themedImage--dark_wwiP navbar__logo"><b class="navbar__title">秘密基地</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">笔记📒</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/physicshi" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_mu0C"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_nWAW react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_MFxJ">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_MFxJ">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_IIrL"><button class="clean-btn backToTopButton_x+Rm" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_psz0"><div class="sidebar_aYCW"><nav class="menu thin-scrollbar menu_h+Ol menuWithAnnouncementBar_GKH3"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/intro">写在前面</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">浏览器</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">CSS</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">JavaScript</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Webpack</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Vite</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Babel</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">React</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">NodeJS</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">不只是前端</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">探索</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/探索/Rust">Rust</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/探索/Go">Go</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/探索/MySQL">MySQL</a></li><li class="menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/探索/Nginx">Nginx</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/探索/Docker">Docker</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/探索/OS">OS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/探索/部署">部署</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/探索/CookieSessionToken">CookieSessionToken</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/探索/一些面试">一些面试</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">leetcode</a></li></ul></nav></div></aside><main class="docMainContainer_jMVY"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_+GTl"><div class="docItemContainer_RH7h"><article><div class="tocCollapsible_y1bX tocMobile_zI+Y"><button type="button" class="clean-btn tocCollapsibleButton_U+cm">On this page</button></div><div class="markdown"><header><h1>Nginx</h1></header><div class="codeBlockContainer_JfZT"><div class="codeBlockContent_4mTi shell"><pre tabindex="0" class="prism-code language-shell codeBlock_P3uO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_+v3f"><span class="token-line" style="color:#393A34"><span class="token plain">brew update</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ww6L clean-btn">Copy</button></div></div><div class="codeBlockContainer_JfZT"><div class="codeBlockContent_4mTi shell"><pre tabindex="0" class="prism-code language-shell codeBlock_P3uO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_+v3f"><span class="token-line" style="color:#393A34"><span class="token plain">brew </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> nginx</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ww6L clean-btn">Copy</button></div></div><p>安装成功后，可执行脚本会自动加入环境变量；</p><p>其中关键配置及默认路径如下：</p><ul><li>安装目录：<code>--prefix=/opt/homebrew/Cellar/nginx/1.21.5</code></li><li>执行脚本： <code>/opt/homebrew/Cellar/nginx/1.21.5/bin/nginx</code></li><li>配置文件： <code>/opt/homebrew/etc/nginx/nginx.conf</code></li><li>日志文件： <code>/opt/homebrew/var/log/nginx/access.log</code></li><li>错误日志： <code>/opt/homebrew/var/log/nginx/error.log</code></li></ul><p>启动：<code>nginx</code> ，然后访问 http://localhost:8080/ （默认就是 8080 端口，可在配置文件中修改）</p><blockquote><p>另外:</p><p>查看本机地址命令式是：<code>ifconfig</code></p><p>查看端口占用情况：<code>sudo netstat -tupln | grep 端口号</code> http 默认端口号是 80</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_jJj8" id="nginx-架构模型及常用命令操作"></a>nginx 架构模型及常用命令操作<a class="hash-link" href="#nginx-架构模型及常用命令操作" title="Direct link to heading">#</a></h2><p>master 主进程下面开启一些 worker 子进程</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_jJj8" id="nginx-常用命令参数"></a>nginx 常用命令、参数<a class="hash-link" href="#nginx-常用命令参数" title="Direct link to heading">#</a></h3><ul><li><code>nginx -t</code> 测试配置是否正确，配置文件修改后先操作验证，再进行后续操作</li><li><code>nginx -s reload</code> 加载最新配置，等待全部子进程结束，然后开辟的新的子进程使用新的配置</li><li><code>nginx -s reopen</code> 重新打开日志，重命名 access.log 文件，并重新创建新的 access.log 文件，再次访问查看变化</li><li><code>nginx -s quit</code> 优雅停止，等待全部子进程处理完毕，不再开启新的子进程</li><li><code>nginx -s stop</code> 立即停止，不等待子进程处理，立即停止所有子进程及主进程</li></ul><p>对于其他操作命令，具体可以使用帮助命令 nginx -h 进行查看</p><p>确认启动成功，直接访问对应 ip 地址，我们就可以看到 nginx 返回的默认 html 静态欢迎界面了</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_jJj8" id="配置项及其含义"></a>配置项及其含义<a class="hash-link" href="#配置项及其含义" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_jJj8" id="全局配置区域"></a>全局配置区域<a class="hash-link" href="#全局配置区域" title="Direct link to heading">#</a></h3><p>当前环境下，nginx 的配置文件在 /etc/nginx 文件夹下，同时，我们可以使用 nginx -V 查看版本，选项配置及模块选项</p><p>首先，我们来看一下配置文件的各个区域，我们可以使用 vim 打开进行查看。</p><div class="codeBlockContainer_JfZT"><div class="codeBlockContent_4mTi"><pre tabindex="0" class="prism-code language-undefined codeBlock_P3uO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_+v3f"><span class="token-line" style="color:#393A34"><span class="token plain">main # 全局配置区域，nginx核心功能配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">events{ # events 事件区，子进程核心配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">http{ # http服务器配置区</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    server{ # 不同服务配置区</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        location { # location 不同请求路径配置区</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">mail{ # 邮件代理配置区</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    server{ # 邮件服务配置区</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ww6L clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_jJj8" id="默认配置解析"></a>默认配置解析<a class="hash-link" href="#默认配置解析" title="Direct link to heading">#</a></h3><p>如果配置项中出现<code>include /xx/xx</code> ，是指引入外部配置项；# 号则是注释内容。</p><p>在安装完毕后，可以使用 <code>egrep -v &quot;#|^$&quot; nginx.conf</code>打印去掉包含#号和空格的内容，展示默认配置选项进行解读。</p><div class="codeBlockContainer_JfZT"><div class="codeBlockContent_4mTi"><pre tabindex="0" class="prism-code language-undefined codeBlock_P3uO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_+v3f"><span class="token-line" style="color:#393A34"><span class="token plain">#运行用户</span></span><span class="token-line" style="color:#393A34"><span class="token plain">user nobody;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#启动进程,通常设置成和cpu的数量相等</span></span><span class="token-line" style="color:#393A34"><span class="token plain">worker_processes  1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#全局错误日志及PID文件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#error_log  logs/error.log;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#error_log  logs/error.log  notice;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#error_log  logs/error.log  info;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#pid        logs/nginx.pid;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#工作模式及连接数上限</span></span><span class="token-line" style="color:#393A34"><span class="token plain">events {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #epoll是多路复用IO(I/O Multiplexing)中的一种方式,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #仅用于linux2.6以上内核,可以大大提高nginx的性能</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    use   epoll;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #单个后台worker process进程的最大并发链接数</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    worker_connections  1024;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 并发总数是 worker_processes 和 worker_connections 的乘积</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 即 max_clients = worker_processes * worker_connections</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 在设置了反向代理的情况下，max_clients = worker_processes * worker_connections / 4  为什么</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 为什么上面反向代理要除以4，应该说是一个经验值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 根据以上条件，正常情况下的Nginx Server可以应付的最大连接数为：4 * 8000 = 32000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # worker_connections 值的设置跟物理内存大小有关</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 因为并发受IO约束，max_clients的值须小于系统可以打开的最大文件数</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 而系统可以打开的最大文件数和内存大小成正比，一般1GB内存的机器上可以打开的文件数大约是10万左右</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 我们来看看360M内存的VPS可以打开的文件句柄数是多少：</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # $ cat /proc/sys/fs/file-max</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 输出 34336</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 32000 &lt; 34336，即并发连接总数小于系统可以打开的文件句柄总数，这样就在操作系统可以承受的范围之内</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 所以，worker_connections 的值需根据 worker_processes 进程数目和系统可以打开的最大文件总数进行适当地进行设置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 使得并发总数小于操作系统可以打开的最大文件数目</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其实质也就是根据主机的物理CPU和内存进行配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 当然，理论上的并发总数可能会和实际有所偏差，因为主机还有其他的工作进程需要消耗系统资源。</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # ulimit -SHn 65535</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">http {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #设定mime类型,类型由mime.type文件定义</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    include    mime.types;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default_type  application/octet-stream;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #设定日志格式</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    access_log  logs/access.log  main;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件，</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #对于普通应用，必须设为 on,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #如果用来进行下载等应用磁盘IO重负载应用，可设置为 off，</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #以平衡磁盘与网络I/O处理速度，降低系统的uptime.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    sendfile     on;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #tcp_nopush     on;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #连接超时时间</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #keepalive_timeout  0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    keepalive_timeout  65;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    tcp_nodelay     on;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #开启gzip压缩</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    gzip  on;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    gzip_disable &quot;MSIE [1-6].&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #设定请求缓冲</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    client_header_buffer_size    128k;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    large_client_header_buffers  4 128k;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    #设定虚拟主机配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    server {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        #侦听80端口</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        listen    80;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        #定义使用 www.nginx.cn访问</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        server_name  www.nginx.cn;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        #定义服务器的默认网站根目录位置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        root html;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        #设定本虚拟主机的访问日志</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        access_log  logs/nginx.access.log  main;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        #默认请求</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        location / {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            #定义首页索引文件的名称</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            index index.php index.html index.htm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 定义错误提示页面</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        error_page   500 502 503 504 /50x.html;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        location = /50x.html {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        #静态文件，nginx自己处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        location ~ ^/(images|javascript|js|css|flash|media|static)/ {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            #过期30天，静态文件不怎么更新，过期可以设大一点，</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            #如果频繁更新，则可以设置得小一点。</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            expires 30d;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        #PHP 脚本请求全部转发到 FastCGI处理. 使用FastCGI默认配置.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        location ~ .php$ {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            fastcgi_pass 127.0.0.1:9000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            fastcgi_index index.php;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            include fastcgi_params;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        #禁止访问 .htxxx 文件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            location ~ /.ht {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            deny all;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ww6L clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_jJj8" id="反向代理"></a>反向代理<a class="hash-link" href="#反向代理" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_jJj8" id="基本概念"></a>基本概念<a class="hash-link" href="#基本概念" title="Direct link to heading">#</a></h3><p>反向代理是客户端去请求资源被代理服务器拦截，分发到合理的服务或服务器，然后发送给客户端，可以理解为代理的是服务器，客户端不知道自己访问的是真实地服务器还是代理服务器。</p><p>正向代理是客户端先把请求发送给正向代理服务器，正向代理服务器再将请求发送出去，获取到资源后，再将资源发送回客户端，可以理解为代理的是客户端。</p><p><strong>正向代理是代理客户端，反向代理代理的是服务器</strong></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_jJj8" id="简单实践"></a>简单实践<a class="hash-link" href="#简单实践" title="Direct link to heading">#</a></h3><p>配置两台服务器：</p><p>一台专门用来做业务逻辑的响应，设置端口 3000；一台专门用于处理图片资源响应，设置端口 3001</p><ul><li>业务逻辑响应代码：</li></ul><div class="codeBlockContainer_JfZT"><div class="codeBlockContent_4mTi js"><pre tabindex="0" class="prism-code language-js codeBlock_P3uO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_+v3f"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// node-server.js</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> http </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;http&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:3000&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;request&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">url</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;node----server&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;404&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ww6L clean-btn">Copy</button></div></div><ul><li>图片资源响应代码</li></ul><div class="codeBlockContainer_JfZT"><div class="codeBlockContent_4mTi js"><pre tabindex="0" class="prism-code language-js codeBlock_P3uO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_+v3f"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// server-img.js</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> http </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;http&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> fs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;fs&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3001</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:3001&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;request&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  fs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">readFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;.&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">err</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;没有这个文件&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ww6L clean-btn">Copy</button></div></div><p>启动上面两个服务后，对 nginx 配置文件的 server 项进行修改</p><div class="codeBlockContainer_JfZT"><div class="codeBlockContent_4mTi"><pre tabindex="0" class="prism-code language-undefined codeBlock_P3uO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_+v3f"><span class="token-line" style="color:#393A34"><span class="token plain">location / {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_pass http://127.0.0.1:3000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">location ~ \.(jpg|png)$ {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_pass http://127.0.0.1:3001;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ww6L clean-btn">Copy</button></div></div><p>通过命令 nginx -s reload 重新加载配置文件，就可以访问不同的内容了，由 nginx 代理到不同的内部服务器，提供不同的资源响应。</p><p>我们修改代码，让响应内容集成，将 nginx 默认响应的 html 复制到自己的资源根目录中，由业务逻辑服务器进行处理加载。</p><div class="codeBlockContainer_JfZT"><div class="codeBlockContent_4mTi html"><pre tabindex="0" class="prism-code language-html codeBlock_P3uO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_+v3f"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">h1</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">node----server</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">h1</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">img</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">./img/h-lf.jpg</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ww6L clean-btn">Copy</button></div></div><p>修改业务逻辑代码，加载 html 静态页面资源</p><div class="codeBlockContainer_JfZT"><div class="codeBlockContent_4mTi js"><pre tabindex="0" class="prism-code language-js codeBlock_P3uO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_+v3f"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> http </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;http&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> fs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;fs&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:3000&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;request&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">url</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">readFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./index.html&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">err</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;error&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ww6L clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_jJj8" id="服务器集群和负载均衡"></a>服务器集群和负载均衡<a class="hash-link" href="#服务器集群和负载均衡" title="Direct link to heading">#</a></h2><p>内网服务器因为要处理大量的业务逻辑，因此，内网单台服务器的响应能力非常有限，为了提供更快加速的响应，一般会在内网架设多台业务逻辑处理器，当某一台正在工作时，需要由其他的正在闲置的服务器来处理请求响应；</p><p>后端多台相同的业务逻辑服务器，被称为服务器集群；而当请求到来时，到底由哪台服务器进行处理，取决于代理转向哪台服务器，这项能力，叫做负载均衡。</p><p>以图片处理为例，准备三个后端服务：</p><ul><li>server-img1.js 端口 3001</li><li>server-img2.js 端口 3002</li><li>server-img3.js 端口 3003</li></ul><p><code>kill 9 进程号</code> 杀死某个进程</p><p>修改配置文件：</p><div class="codeBlockContainer_JfZT"><div class="codeBlockContent_4mTi"><pre tabindex="0" class="prism-code language-undefined codeBlock_P3uO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_+v3f"><span class="token-line" style="color:#393A34"><span class="token plain">upstream 自定义连接池名称 {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    server ip:port weight=权重值，越大占比越高 max_fails=最大失败次数 fail_timeout=超时时间</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">serevr {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    location ~ \.(jpg|png)${</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 反向代理到负载连接池</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_pass http://自定义连接池名称;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ww6L clean-btn">Copy</button></div></div><p>所以实际的配置就是</p><div class="codeBlockContainer_JfZT"><div class="codeBlockContent_4mTi"><pre tabindex="0" class="prism-code language-undefined codeBlock_P3uO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_+v3f"><span class="token-line" style="color:#393A34"><span class="token plain"># 写在server外面</span></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream img_server{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    # weight=1 权重最低</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    server 127.0.0.1:3001 weight=1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    server 127.0.0.1:3002 weight=3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    server 127.0.0.1:3003 weight=1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">server{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_pass http://127.0.0.1:3000;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    location ~ \.(jpg|png)$ {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 反向代理到负载均衡池</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_pass http://img_server;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ww6L clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_jJj8" id="参考"></a>参考<a class="hash-link" href="#参考" title="Direct link to heading">#</a></h2><ul><li><a href="https://juejin.cn/post/6844903684967825421" target="_blank" rel="noopener noreferrer">Nginx 与前端开发</a></li><li><a href="https://juejin.cn/post/7007346707767754765" target="_blank" rel="noopener noreferrer">🚗 🚗 🚗 前端仔也需要懂的 nginx 内容</a></li><li><a href="https://juejin.cn/post/6844904144235413512" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844904144235413512</a></li><li><a href="https://juejin.cn/post/6844904020360986631" target="_blank" rel="noopener noreferrer">前端不能不会的 Nginx 入门 （图文并茂的服务器环境教程）</a></li></ul></div><footer class="docusaurus-mt-lg"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/main/website/docs/探索/Nginx.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_UQtd" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_QETb"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/探索/MySQL"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« MySQL</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/探索/Docker"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Docker »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_GySF thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#nginx-架构模型及常用命令操作" class="table-of-contents__link">nginx 架构模型及常用命令操作</a><ul><li><a href="#nginx-常用命令参数" class="table-of-contents__link">nginx 常用命令、参数</a></li></ul></li><li><a href="#配置项及其含义" class="table-of-contents__link">配置项及其含义</a><ul><li><a href="#全局配置区域" class="table-of-contents__link">全局配置区域</a></li><li><a href="#默认配置解析" class="table-of-contents__link">默认配置解析</a></li></ul></li><li><a href="#反向代理" class="table-of-contents__link">反向代理</a><ul><li><a href="#基本概念" class="table-of-contents__link">基本概念</a></li><li><a href="#简单实践" class="table-of-contents__link">简单实践</a></li></ul></li><li><a href="#服务器集群和负载均衡" class="table-of-contents__link">服务器集群和负载均衡</a></li><li><a href="#参考" class="table-of-contents__link">参考</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">笔记📒</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_mu0C"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_mu0C"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_mu0C"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/physicshi" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_mu0C"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 wsgy, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.6ef7fc14.js"></script>
<script src="/assets/js/main.c78f278f.js"></script>
</body>
</html>